rules_version = '2';
service cloud.firestore {
  // Security Rules for HireAll Platform
  // Expanded to support:
  // - Per-user data segregation
  // - Admin dashboard (users, sponsored companies, sponsorship rules, contacts)
  // - Saved user settings
  // - Public portfolio subdomains
  // - Strict write validation
  //
  // Conventions:
  // - User "admin" status is determined by the boolean field `isAdmin` on their own user document: /users/{uid}
  // - Admin permissions are evaluated dynamically via get() of their user record
  // - Normal users cannot escalate themselves to admin
  // - Collections covered:
  //     users, user_settings, resumes (subcollection of users), cvAnalyses,
  //     jobs, applications, sponsoredCompanies, sponsorshipRules,
  //     contacts, subdomains
  //
  // NOTE: Any server-side privileged operations (e.g. batch maintenance,
  // indexing, migrations) should use the Admin SDK and bypass these rules.

  match /databases/{database}/documents {

    // ------------- Helper Functions -------------
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // True if the currently authenticated user has isAdmin == true on their own user doc
    function isAdmin() {
      return isSignedIn()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // Prevent non-admin users from modifying protected admin-only fields on their own document
    function userUpdateIsSafe(userId) {
      // If user is not admin, they cannot set or change isAdmin
      return isOwner(userId)
        && !(("isAdmin" in request.resource.data)
             && request.resource.data.isAdmin != resource.data.isAdmin);
    }

    // Disallow client changes to immutable timestamp fields unless creating
    function immutableOnUpdate(field) {
      return !(field in request.resource.data)
        || request.resource.data[field] == resource.data[field];
    }

    // Generic createdAt/updatedAt validation
    function validTimestamps(isCreate) {
      return (isCreate && ("createdAt" in request.resource.data))
        || (!isCreate && immutableOnUpdate("createdAt"));
    }

    // ------------- Users Collection -------------
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId)
        && request.resource.data.keys().hasOnly([
          'email', 'name', 'createdAt', 'updatedAt', 'provider', 'isAdmin', 'subscriptionPlan'
        ])
        // Non-admin cannot force isAdmin true on create
        && ( !('isAdmin' in request.resource.data) || request.resource.data.isAdmin == false )
        && validTimestamps(true);

      allow update: if (
          // Owner updating their own safe fields
          (userUpdateIsSafe(userId))
          ||
          // Admin can update any user (including toggling isAdmin)
          isAdmin()
        )
        && validTimestamps(false);

      allow delete: if isOwner(userId) || isAdmin();
    }

    // ------------- User Settings (per user) -------------
    // Stores personalization: savedViews, preferences, feature flags, etc.
    match /user_settings/{userId} {
      allow read, create, update, delete: if isOwner(userId) || isAdmin();
    }

    // ------------- User Resumes Subcollection -------------
    match /users/{userId}/resumes/{resumeId} {
      allow read: if resource.data.visibility == 'public' || isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update, delete: if isOwner(userId) || isAdmin();
    }

    // ------------- CV Analyses -------------
    // Each analysis references a userId in its data
    match /cvAnalyses/{analysisId} {
      allow read, update, delete: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;
    }

    // ------------- Jobs -------------
    match /jobs/{jobId} {
      allow read: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ------------- Applications -------------
    match /applications/{applicationId} {
      allow read: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ------------- Sponsored Companies (Admin-managed) -------------
    match /sponsoredCompanies/{companyId} {
      // Public read to allow client-side sponsorship detection & UI
      allow read: if true;
      // Only admins can create/update/delete
      allow create, update, delete: if isAdmin();
    }

    // ------------- Sponsors (Public data) -------------
    match /sponsors/{sponsorId} {
      // Public read to allow client-side sponsor data access
      allow read: if true;
      // Only admins can create/update/delete
      allow create, update, delete: if isAdmin();
    }

    // ------------- Sponsorship Rules (Admin-managed scraping / detection logic) -------------
    match /sponsorshipRules/{ruleId} {
      allow read: if true; // Public read if client extension or UI needs selectors
      allow create, update, delete: if isAdmin();
    }

    // ------------- Contact Submissions -------------
    // Public form submissions allowed (even unauthenticated)
    match /contacts/{contactId} {
      allow create: if true;
      // Only admins can read or mutate responses
      allow read, update, delete: if isAdmin();
    }

    // ------------- Public Subdomain Claims -------------
    // Used for portfolio/public pages. Immutable after creation (except admin may intervene if needed).
    match /subdomains/{sub} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && !resource.exists();
      allow update: if false; // Immutable by default
      allow delete: if isAdmin(); // Admin override
    }

    // ------------- Subscriptions (Server-managed via Stripe webhooks) -------------
    // Client reads only their own subscription; writes are server-side only
    match /subscriptions/{subscriptionId} {
      allow read: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
      allow create, update, delete: if false; // Server-side only via Admin SDK
    }

    // ------------- Subscription Checkouts (Server-managed) -------------
    match /subscriptionCheckouts/{checkoutId} {
      allow read: if isAdmin();
      allow create, update, delete: if false; // Server-side only
    }

    // ------------- Subscription Recovery Logs (Admin only) -------------
    match /subscriptionRecoveryLogs/{logId} {
      allow read: if isAdmin();
      allow create, update, delete: if false; // Server-side only
    }

    // ------------- System Health Logs (Admin only) -------------
    match /systemHealthLogs/{logId} {
      allow read: if isAdmin();
      allow create, update, delete: if false; // Server-side only
    }

    // ------------- Webhook Logs (Admin only) -------------
    match /webhookLogs/{logId} {
      allow read: if isAdmin();
      allow create, update, delete: if false; // Server-side only
    }

    // ------------- Blog Posts -------------
    match /blogPosts/{postId} {
      // Public read for published posts, admin reads all
      allow read: if resource.data.status == 'published' || isAdmin();
      // Only admins can create/update/delete
      allow create, update, delete: if isAdmin();
    }

    // ------------- SOC Codes (Public reference data) -------------
    match /socCodes/{codeId} {
      allow read: if true; // Public reference data
      allow create, update, delete: if isAdmin();
    }

    // ------------- Interview Questions (Authenticated users) -------------
    match /interviewQuestions/{questionId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    // ------------- Email Campaigns (Admin only) -------------
    match /emailCampaigns/{campaignId} {
      allow read, create, update, delete: if isAdmin();
    }

    // ------------- Email Sends (Admin only) -------------
    match /emailSends/{sendId} {
      allow read: if isAdmin();
      allow create, update, delete: if false; // Server-side only
    }

    // ------------- Conversations (Chatbot) -------------
    match /conversations/{conversationId} {
      allow read, create, update: if isSignedIn()
        && (resource == null || resource.data.userId == request.auth.uid);
      allow delete: if isOwner(resource.data.userId) || isAdmin();

      // Messages subcollection
      match /messages/{messageId} {
        allow read, create: if isSignedIn()
          && get(/databases/$(database)/documents/conversations/$(conversationId)).data.userId == request.auth.uid;
        allow update, delete: if false; // Messages are immutable
      }
    }

    // ------------- Fallback -------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
