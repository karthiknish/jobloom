rules_version = '2';
service cloud.firestore {
  // Security Rules for HireAll Platform
  // ====================================
  // Supports:
  // - Per-user data segregation
  // - Admin dashboard (users, sponsored companies, sponsorship rules, contacts)
  // - CV analyses and resume management
  // - Public portfolio subdomains
  // - Blog and content management
  // - Subscription and payment handling
  // - Issue reports and volunteer applications
  //
  // Conventions:
  // - User "admin" status is determined by the boolean field `isAdmin` on their user doc
  // - Admin permissions are evaluated dynamically via get() of their user record
  // - Normal users cannot escalate themselves to admin
  // - Server-side operations use Admin SDK and bypass these rules
  //
  // Last Updated: December 2024

  match /databases/{database}/documents {

    // ============ HELPER FUNCTIONS ============
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Check if current user has admin privileges
    function isAdmin() {
      return isSignedIn()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // Prevent non-admin users from modifying protected admin-only fields
    function userUpdateIsSafe(userId) {
      return isOwner(userId)
        && !(("isAdmin" in request.resource.data)
             && request.resource.data.isAdmin != resource.data.isAdmin);
    }

    // Disallow client changes to immutable timestamp fields unless creating
    function immutableOnUpdate(field) {
      return !(field in request.resource.data)
        || request.resource.data[field] == resource.data[field];
    }

    // Generic createdAt/updatedAt validation
    function validTimestamps(isCreate) {
      return (isCreate && ("createdAt" in request.resource.data))
        || (!isCreate && immutableOnUpdate("createdAt"));
    }

    // Validate string field length
    function validStringLength(field, maxLen) {
      return !(field in request.resource.data)
        || request.resource.data[field].size() <= maxLen;
    }

    // ============ USERS COLLECTION ============
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      
      allow create: if isOwner(userId)
        && request.resource.data.keys().hasOnly([
          'email', 'name', 'displayName', 'createdAt', 'updatedAt', 
          'provider', 'isAdmin', 'subscriptionPlan', 'photoURL',
          'emailPreferences', 'lastLoginAt', 'emailVerified'
        ])
        // Non-admin cannot force isAdmin true on create
        && ( !('isAdmin' in request.resource.data) || request.resource.data.isAdmin == false )
        && validTimestamps(true);

      allow update: if (
          // Owner updating their own safe fields
          (userUpdateIsSafe(userId))
          ||
          // Admin can update any user (including toggling isAdmin)
          isAdmin()
        )
        && validTimestamps(false);

      allow delete: if isOwner(userId) || isAdmin();
    }

    // ============ USER SETTINGS ============
    match /user_settings/{userId} {
      allow read, create, update, delete: if isOwner(userId) || isAdmin();
    }

    // ============ USER RESUMES SUBCOLLECTION ============
    match /users/{userId}/resumes/{resumeId} {
      allow read: if resource.data.visibility == 'public' || isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update, delete: if isOwner(userId) || isAdmin();
    }

    // ============ CV ANALYSES ============
    match /cvAnalyses/{analysisId} {
      allow read, update, delete: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;
    }

    // ============ JOBS ============
    match /jobs/{jobId} {
      allow read: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ============ APPLICATIONS ============
    match /applications/{applicationId} {
      allow read: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ============ SPONSORED COMPANIES (Admin-managed) ============
    match /sponsoredCompanies/{companyId} {
      allow read: if true; // Public for client-side sponsorship detection
      allow create, update, delete: if isAdmin();
    }

    // ============ SPONSORS (Public data) ============
    match /sponsors/{sponsorId} {
      allow read: if true; // Public for client-side sponsor data access
      allow create, update, delete: if isAdmin();
    }

    // ============ SPONSORSHIP RULES (Admin-managed) ============
    match /sponsorshipRules/{ruleId} {
      allow read: if true; // Public if client extension or UI needs selectors
      allow create, update, delete: if isAdmin();
    }

    // ============ CONTACT SUBMISSIONS ============
    // Public form submissions allowed (even unauthenticated)
    match /contacts/{contactId} {
      // Anyone can create a contact (for contact form, issue reports, volunteer apps)
      allow create: if true
        && validStringLength('name', 100)
        && validStringLength('email', 254)
        && validStringLength('message', 10000)
        && validStringLength('subject', 200);
      // Only admins can read or mutate
      allow read, update, delete: if isAdmin();
    }

    // ============ ISSUE REPORTS ============
    // For the Report Issue feature - saved as contacts but can have separate collection
    match /issueReports/{reportId} {
      allow create: if true
        && validStringLength('description', 5000)
        && validStringLength('page', 500);
      allow read, update, delete: if isAdmin();
    }

    // ============ VOLUNTEER APPLICATIONS ============
    match /volunteerApplications/{applicationId} {
      // Anyone can submit a volunteer application
      allow create: if true
        && validStringLength('name', 100)
        && validStringLength('email', 254)
        && validStringLength('message', 5000);
      // Only admins can read or mutate
      allow read, update, delete: if isAdmin();
    }

    // ============ PUBLIC SUBDOMAIN CLAIMS ============
    match /subdomains/{sub} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && !resource.exists();
      allow update: if false; // Immutable by default
      allow delete: if isAdmin(); // Admin override
    }

    // ============ SUBSCRIPTIONS (Server-managed) ============
    match /subscriptions/{subscriptionId} {
      allow read: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
      allow create, update, delete: if false; // Server-side only via Admin SDK
    }

    // ============ SUBSCRIPTION CHECKOUTS (Server-managed) ============
    match /subscriptionCheckouts/{checkoutId} {
      allow read: if isAdmin();
      allow create, update, delete: if false; // Server-side only
    }

    // ============ SUBSCRIPTION RECOVERY LOGS (Admin only) ============
    match /subscriptionRecoveryLogs/{logId} {
      allow read: if isAdmin();
      allow create, update, delete: if false; // Server-side only
    }

    // ============ SYSTEM HEALTH LOGS (Admin only) ============
    match /systemHealthLogs/{logId} {
      allow read: if isAdmin();
      allow create, update, delete: if false; // Server-side only
    }

    // ============ WEBHOOK LOGS (Admin only) ============
    match /webhookLogs/{logId} {
      allow read: if isAdmin();
      allow create, update, delete: if false; // Server-side only
    }

    // ============ SECURITY LOGS (Admin only) ============
    match /securityLogs/{logId} {
      allow read: if isAdmin();
      allow create, update, delete: if false; // Server-side only
    }

    // ============ RATE LIMIT LOGS (Admin only) ============
    match /rateLimitLogs/{logId} {
      allow read: if isAdmin();
      allow create, update, delete: if false; // Server-side only
    }

    // ============ BLOG POSTS ============
    match /blogPosts/{postId} {
      allow read: if resource.data.status == 'published' || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    // ============ SOC CODES (Public reference data) ============
    match /socCodes/{codeId} {
      allow read: if true; // Public reference data
      allow create, update, delete: if isAdmin();
    }

    // ============ INTERVIEW QUESTIONS ============
    match /interviewQuestions/{questionId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    // ============ EMAIL CAMPAIGNS (Admin only) ============
    match /emailCampaigns/{campaignId} {
      allow read, create, update, delete: if isAdmin();
    }

    // ============ EMAIL SENDS (Admin only) ============
    match /emailSends/{sendId} {
      allow read: if isAdmin();
      allow create, update, delete: if false; // Server-side only
    }

    // ============ EMAIL TEMPLATES (Admin only) ============
    match /emailTemplates/{templateId} {
      allow read, create, update, delete: if isAdmin();
    }

    // ============ CONVERSATIONS (Chatbot) ============
    match /conversations/{conversationId} {
      allow read, create, update: if isSignedIn()
        && (resource == null || resource.data.userId == request.auth.uid);
      allow delete: if isOwner(resource.data.userId) || isAdmin();

      // Messages subcollection
      match /messages/{messageId} {
        allow read, create: if isSignedIn()
          && get(/databases/$(database)/documents/conversations/$(conversationId)).data.userId == request.auth.uid;
        allow update, delete: if false; // Messages are immutable
      }
    }

    // ============ ANALYTICS EVENTS (Server-managed) ============
    match /analyticsEvents/{eventId} {
      allow read: if isAdmin();
      allow create, update, delete: if false; // Server-side only
    }

    // ============ FEATURE FLAGS (Admin only) ============
    match /featureFlags/{flagId} {
      allow read: if true; // Client can read feature flags
      allow create, update, delete: if isAdmin();
    }

    // ============ NOTIFICATIONS ============
    match /notifications/{notificationId} {
      allow read: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if false; // Server-side only
      allow update: if isSignedIn()
        && resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasOnly(['read', 'readAt']);
      allow delete: if isSignedIn()
        && resource.data.userId == request.auth.uid;
    }

    // ============ FALLBACK - DENY ALL ============
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
