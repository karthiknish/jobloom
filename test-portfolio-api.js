#!/usr/bin/env node

/**
 * Portfolio API Integration Test
 *
 * This script tests all portfolio-related API endpoints in the HireAll webapp
 * to ensure they work correctly with proper validation, authentication, and security.
 *
 * Tests the following endpoints:
 * - GET /api/portfolio/resume - Get user's resume data
 * - POST /api/portfolio/resume - Create/update resume
 * - GET /api/portfolio/site - Get portfolio site configuration
 * - POST /api/portfolio/site - Update portfolio site configuration
 *
 * Run with: node test-portfolio-api.js
 */

const https = require('https');
const http = require('http');

// Configuration
const BASE_URL = process.env.BASE_URL || 'http://localhost:3000';
const TEST_USER_EMAIL = process.env.TEST_USER_EMAIL || 'test@example.com';
const TEST_USER_PASSWORD = process.env.TEST_USER_PASSWORD || 'testpassword123';

// Mock authentication token (generated by generate-test-token.js)
const MOCK_AUTH_TOKEN = process.env.MOCK_AUTH_TOKEN || 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20vaGlyZWFsbC00ZjEwNiIsImF1ZCI6ImhpcmVhbGwtNGYxMDYiLCJhdXRoX3RpbWUiOjE3NTk3MzY1MzUsInVzZXJfaWQiOiJ0ZXN0LXVzZXItMTIzIiwic3ViIjoidGVzdC11c2VyLTEyMyIsImlhdCI6MTc1OTczNjUzNSwiZXhwIjoxNzU5NzQwMTM1LCJlbWFpbCI6InRlc3RAZXhhbXBsZS5jb20iLCJlbWFpbF92ZXJpZmllZCI6dHJ1ZSwiZmlyZWJhc2UiOnsiaWRlbnRpdGllcyI6eyJlbWFpbCI6WyJ0ZXN0QGV4YW1wbGUuY29tIl19LCJzaWduX2luX3Byb3ZpZGVyIjoicGFzc3dvcmQifX0.bW9jay1zaWduYXR1cmUtZm9yLXRlc3Rpbmc';

let authToken = MOCK_AUTH_TOKEN;
let testUserId = process.env.TEST_USER_ID || 'test-user-123';

// CSRF token storage
let csrfToken = null;
let csrfCookie = null;

// Test results tracking
const results = {
  total: 0,
  passed: 0,
  failed: 0,
  tests: []
};

function log(message) {
  console.log(`[${new Date().toISOString()}] ${message}`);
}

function recordTest(name, passed, error = null) {
  results.total++;
  if (passed) {
    results.passed++;
  } else {
    results.failed++;
  }

  results.tests.push({
    name,
    passed,
    error: error ? error.message : null,
    timestamp: new Date().toISOString()
  });

  const status = passed ? 'âœ… PASS' : 'âŒ FAIL';
  log(`${status} ${name}`);
  if (error) {
    console.log(`   Error: ${error.message}`);
  }
}

// HTTP request helper
function makeRequest(url, options = {}) {
  return new Promise((resolve, reject) => {
    const protocol = url.startsWith('https:') ? https : http;
    const req = protocol.request(url, options, (res) => {
      let data = '';
      res.on('data', (chunk) => data += chunk);
      res.on('end', () => {
        try {
          const jsonData = data ? JSON.parse(data) : {};
          resolve({
            status: res.statusCode,
            headers: res.headers,
            data: jsonData
          });
        } catch (e) {
          resolve({
            status: res.statusCode,
            headers: res.headers,
            data: data
          });
        }
      });
    });

    req.on('error', reject);

    if (options.body) {
      req.write(JSON.stringify(options.body));
    }

    req.end();
  });
}

/**
 * Get CSRF token from server
 */
async function getCsrfToken() {
  return new Promise((resolve, reject) => {
    const url = `${BASE_URL}/api/health`;
    const urlObj = new URL(url);

    const requestOptions = {
      hostname: urlObj.hostname,
      port: urlObj.port,
      path: urlObj.pathname + urlObj.search,
      method: 'GET',
      headers: {}
    };

    const protocol = url.startsWith('https://') ? https : http;
    const req = protocol.request(requestOptions, (res) => {
      let data = '';

      // Extract CSRF cookie from response
      const setCookieHeader = res.headers['set-cookie'];
      if (setCookieHeader) {
        const csrfCookieMatch = setCookieHeader.find(cookie => cookie.startsWith('__csrf-token='));
        if (csrfCookieMatch) {
          csrfCookie = csrfCookieMatch.split(';')[0].split('=')[1];
          csrfToken = csrfCookie;
        }
      }

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        resolve({ status: res.statusCode, csrfToken, csrfCookie });
      });
    });

    req.on('error', () => {
      resolve(false);
    });

    req.on('timeout', () => {
      req.destroy();
      resolve(false);
    });

    req.end();
  });
}

// API request helper with auth
async function apiRequest(method, path, body = null, auth = true) {
  const url = `${BASE_URL}${path}`;
  const headers = {
    'Content-Type': 'application/json',
    'User-Agent': 'HireAll-Portfolio-API-Test/1.0'
  };

  if (auth && authToken) {
    headers['Authorization'] = `Bearer ${authToken}`;
  }

  // Add CSRF token for non-GET requests
  if (method !== 'GET' && csrfToken) {
    headers['x-csrf-token'] = csrfToken;
    if (csrfCookie) {
      headers['Cookie'] = `__csrf-token=${csrfCookie}`;
    }
  }

  const options = {
    method,
    headers
  };

  if (body) {
    options.body = body;
  }

  return makeRequest(url, options);
}

// Authentication setup
async function setupAuth() {
  log('Setting up mock authentication...');

  try {
    // Get CSRF token first
    const csrfResult = await getCsrfToken();
    if (!csrfResult || !csrfResult.csrfToken) {
      throw new Error('Failed to obtain CSRF token');
    }
    log('CSRF token obtained');

    // Use mock authentication (same as other test scripts)
    recordTest('Authentication Setup', true);
    log(`Using mock authentication for user: ${testUserId}`);
  } catch (error) {
    recordTest('Authentication Setup', false, error);
    throw error;
  }
}

// Test resume data retrieval
async function testGetResume() {
  log('Testing resume data retrieval...');

  try {
    const response = await apiRequest('GET', '/api/portfolio/resume');

    if (response.status === 200 && typeof response.data === 'object') {
      recordTest('GET /api/portfolio/resume - Get Resume', true);
      log('Resume data retrieved successfully');
    } else if (response.status === 404) {
      // Resume doesn't exist yet, which is acceptable
      recordTest('GET /api/portfolio/resume - Resume Not Found (expected)', true);
      log('Resume not found (expected for new user)');
    } else {
      throw new Error(`Unexpected response: ${response.status} - ${JSON.stringify(response.data)}`);
    }
  } catch (error) {
    recordTest('GET /api/portfolio/resume - Get Resume', false, error);
  }
}

// Test resume creation/update
async function testCreateResume() {
  log('Testing resume creation/update...');

  const resumeData = {
    personalInfo: {
      name: 'John Doe',
      email: 'john.doe@example.com',
      phone: '+1 (555) 123-4567',
      location: 'San Francisco, CA',
      linkedin: 'https://linkedin.com/in/johndoe',
      website: 'https://johndoe.dev'
    },
    experience: [
      {
        company: 'TechCorp Inc.',
        position: 'Senior Full Stack Developer',
        startDate: '2022-01',
        endDate: 'Present',
        description: 'Led development of scalable web applications serving 100K+ users',
        technologies: ['React', 'Node.js', 'TypeScript', 'PostgreSQL']
      },
      {
        company: 'StartupXYZ',
        position: 'Full Stack Developer',
        startDate: '2020-03',
        endDate: '2021-12',
        description: 'Built MVP from scratch and grew user base to 10K users',
        technologies: ['Vue.js', 'Python', 'MongoDB', 'AWS']
      }
    ],
    education: [
      {
        institution: 'University of California, Berkeley',
        degree: 'Bachelor of Science in Computer Science',
        graduationDate: '2020',
        gpa: '3.8'
      }
    ],
    skills: [
      {
        category: 'Frontend',
        skills: ['React', 'Vue.js', 'TypeScript', 'JavaScript', 'HTML', 'CSS']
      },
      {
        category: 'Backend',
        skills: ['Node.js', 'Python', 'PostgreSQL', 'MongoDB', 'Redis']
      },
      {
        category: 'DevOps',
        skills: ['AWS', 'Docker', 'Kubernetes', 'CI/CD', 'Terraform']
      }
    ],
    projects: [
      {
        name: 'E-commerce Platform',
        description: 'Full-stack e-commerce solution with payment processing',
        technologies: ['React', 'Node.js', 'Stripe', 'PostgreSQL'],
        githubUrl: 'https://github.com/johndoe/ecommerce',
        liveUrl: 'https://ecommerce-demo.com'
      }
    ]
  };

  try {
    const response = await apiRequest('POST', '/api/portfolio/resume', { resumeData });

    if (response.status === 200 || response.status === 201) {
      recordTest('POST /api/portfolio/resume - Create/Update Resume', true);
      log('Resume created/updated successfully');
    } else {
      throw new Error(`Unexpected status: ${response.status} - ${JSON.stringify(response.data)}`);
    }
  } catch (error) {
    recordTest('POST /api/portfolio/resume - Create/Update Resume', false, error);
  }
}

// Test portfolio site retrieval
async function testGetPortfolioSite() {
  log('Testing portfolio site retrieval...');

  try {
    const response = await apiRequest('GET', '/api/portfolio/site');

    if (response.status === 200 && typeof response.data === 'object') {
      recordTest('GET /api/portfolio/site - Get Portfolio Site', true);
      log('Portfolio site configuration retrieved successfully');
    } else {
      throw new Error(`Unexpected response: ${response.status} - ${JSON.stringify(response.data)}`);
    }
  } catch (error) {
    recordTest('GET /api/portfolio/site - Get Portfolio Site', false, error);
  }
}

// Test portfolio site update
async function testUpdatePortfolioSite() {
  log('Testing portfolio site update...');

  const siteData = {
    templateId: "modern",
    title: "John Doe's Portfolio",
    description: "Full Stack Developer passionate about creating amazing user experiences",
    theme: {
      primaryColor: "#3b82f6",
      secondaryColor: "#64748b",
      fontFamily: "Inter",
      fontSize: "medium",
      spacing: "normal",
      borderRadius: "medium"
    },
    seo: {
      metaTitle: "John Doe - Full Stack Developer",
      metaDescription: "Experienced full stack developer specializing in React, Node.js, and cloud technologies",
      keywords: ["full stack developer", "react", "node.js", "javascript", "web development"]
    },
    sections: [
      {
        id: "hero",
        type: "hero",
        title: "Hero Section",
        content: {
          headline: "Hi, I'm John Doe",
          subheadline: "Full Stack Developer & Problem Solver",
          backgroundImage: "",
          ctaText: "View My Work",
          ctaLink: "#projects"
        }
      },
      {
        id: "about",
        type: "about",
        title: "About Me",
        content: {
          text: "I'm a passionate full stack developer with 5+ years of experience building scalable web applications. I love turning complex problems into simple, beautiful solutions.",
          image: "",
          skills: ["JavaScript", "React", "Node.js", "Python", "AWS"]
        }
      },
      {
        id: "experience",
        type: "experience",
        title: "Work Experience",
        content: {
          experiences: [
            {
              company: "TechCorp Inc.",
              position: "Senior Full Stack Developer",
              period: "2022 - Present",
              description: "Led development of scalable web applications serving 100K+ users"
            }
          ]
        }
      },
      {
        id: "projects",
        type: "projects",
        title: "Featured Projects",
        content: {
          projects: [
            {
              title: "E-commerce Platform",
              description: "Full-stack e-commerce solution with payment processing",
              image: "",
              technologies: ["React", "Node.js", "Stripe"],
              githubUrl: "https://github.com/johndoe/ecommerce",
              liveUrl: "https://ecommerce-demo.com"
            }
          ]
        }
      },
      {
        id: "contact",
        type: "contact",
        title: "Get In Touch",
        content: {
          email: "john.doe@example.com",
          phone: "+1 (555) 123-4567",
          linkedin: "https://linkedin.com/in/johndoe",
          github: "https://github.com/johndoe"
        }
      }
    ]
  };

  try {
    const response = await apiRequest('POST', '/api/portfolio/site', siteData);

    if (response.status === 200 || response.status === 201) {
      recordTest('POST /api/portfolio/site - Update Portfolio Site', true);
      log('Portfolio site updated successfully');
    } else {
      throw new Error(`Unexpected status: ${response.status} - ${JSON.stringify(response.data)}`);
    }
  } catch (error) {
    recordTest('POST /api/portfolio/site - Update Portfolio Site', false, error);
  }
}

// Test resume validation
async function testResumeValidation() {
  log('Testing resume validation...');

  // Test invalid resume data
  const invalidResumeData = {
    personalInfo: "not an object", // Should be an object
    experience: "not an array" // Should be an array
  };

  try {
    const response = await apiRequest('POST', '/api/portfolio/resume', invalidResumeData);

    // Resume API might be more permissive, so we'll check for success or expected error
    if (response.status === 200 || response.status === 201 || response.status === 400) {
      recordTest('POST /api/portfolio/resume - Validation Handling', true);
      log('Resume validation handled appropriately');
    } else {
      throw new Error(`Unexpected status: ${response.status} - ${JSON.stringify(response.data)}`);
    }
  } catch (error) {
    recordTest('POST /api/portfolio/resume - Validation Handling', false, error);
  }
}

// Test portfolio site validation
async function testPortfolioSiteValidation() {
  log('Testing portfolio site validation...');

  // Test invalid site data
  const invalidSiteData = {
    templateId: 123, // Should be a string
    sections: "not an array" // Should be an array
  };

  try {
    const response = await apiRequest('POST', '/api/portfolio/site', invalidSiteData);

    // Portfolio site API might be more permissive, so we'll check for success or expected error
    if (response.status === 200 || response.status === 201 || response.status === 400) {
      recordTest('POST /api/portfolio/site - Validation Handling', true);
      log('Portfolio site validation handled appropriately');
    } else {
      throw new Error(`Unexpected status: ${response.status} - ${JSON.stringify(response.data)}`);
    }
  } catch (error) {
    recordTest('POST /api/portfolio/site - Validation Handling', false, error);
  }
}

// Test authentication failures
async function testAuthFailures() {
  log('Testing authentication failures...');

  // Test without auth token
  try {
    const response = await apiRequest('GET', '/api/portfolio/resume', null, false);

    if (response.status === 401 || response.status === 403) {
      recordTest('Portfolio API - Authentication Required', true);
    } else {
      throw new Error(`Expected 401/403, got ${response.status}`);
    }
  } catch (error) {
    recordTest('Portfolio API - Authentication Required', false, error);
  }

  // Test with invalid token
  try {
    const originalToken = authToken;
    authToken = 'invalid-token';

    const response = await apiRequest('GET', '/api/portfolio/resume');

    if (response.status === 401 || response.status === 403) {
      recordTest('Portfolio API - Invalid Token Handling', true);
    } else {
      throw new Error(`Expected 401/403, got ${response.status}`);
    }

    // Restore token
    authToken = originalToken;
  } catch (error) {
    recordTest('Portfolio API - Invalid Token Handling', false, error);
    // Restore token even on error
    authToken = 'mock-jwt-token-for-testing';
  }
}

// Main test runner
async function runTests() {
  log('ðŸš€ Starting HireAll Portfolio API Tests');
  log(`Testing against: ${BASE_URL}`);

  try {
    await setupAuth();
    await testGetResume();
    await testCreateResume();
    await testGetPortfolioSite();
    await testUpdatePortfolioSite();
    await testResumeValidation();
    await testPortfolioSiteValidation();
    await testAuthFailures();

    // Print results
    log('\nðŸ“Š Test Results Summary:');
    log(`Total Tests: ${results.total}`);
    log(`Passed: ${results.passed}`);
    log(`Failed: ${results.failed}`);
    log(`Success Rate: ${((results.passed / results.total) * 100).toFixed(1)}%`);

    if (results.failed > 0) {
      log('\nâŒ Failed Tests:');
      results.tests.filter(t => !t.passed).forEach(test => {
        log(`  - ${test.name}: ${test.error}`);
      });
    }

    log('\nâœ… Portfolio API testing completed!');

    // Exit with appropriate code
    process.exit(results.failed > 0 ? 1 : 0);

  } catch (error) {
    log(`ðŸ’¥ Test suite failed: ${error.message}`);
    process.exit(1);
  }
}

// Run the tests
if (require.main === module) {
  runTests();
}

module.exports = { runTests };