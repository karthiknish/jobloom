#!/usr/bin/env node

/**
 * Comprehensive API Integration Test
 *
 * This script tests all API endpoints in the HireAll webapp with mock authentication
 * to ensure they work correctly with proper validation, authentication, and security.
 *
 * Tests the following endpoint categories:
 * - AI endpoints (cover letter, resume)
 * - Auth endpoints (password, session)
 * - Blog endpoints
 * - Chatbot endpoints
 * - Contact endpoints
 * - CV endpoints
 * - Email endpoints
 * - Health endpoints
 * - Interview questions endpoints
 * - Rate limit endpoints
 * - Settings endpoints
 * - SOC codes endpoints
 * - Sponsors endpoints
 * - Stripe endpoints
 * - Subdomain endpoints
 * - Subscription endpoints
 * - User endpoints
 *
 * Run with: node test-all-apis.js
 */

const https = require('https');
const http = require('http');

// Configuration
const BASE_URL = process.env.BASE_URL || 'http://localhost:3000';
const TEST_USER_EMAIL = process.env.TEST_USER_EMAIL || 'test@example.com';
const TEST_USER_PASSWORD = process.env.TEST_USER_PASSWORD || 'testpassword123';

// Mock authentication token (generated by generate-test-token.js)
const MOCK_AUTH_TOKEN = process.env.MOCK_AUTH_TOKEN || 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20vaGlyZWFsbC00ZjEwNiIsImF1ZCI6ImhpcmVhbGwtNGYxMDYiLCJhdXRoX3RpbWUiOjE3NTk3MzY1MzUsInVzZXJfaWQiOiJ0ZXN0LXVzZXItMTIzIiwic3ViIjoidGVzdC11c2VyLTEyMyIsImlhdCI6MTc1OTczNjUzNSwiZXhwIjoxNzU5NzQwMTM1LCJlbWFpbCI6InRlc3RAZXhhbXBsZS5jb20iLCJlbWFpbF92ZXJpZmllZCI6dHJ1ZSwiZmlyZWJhc2UiOnsiaWRlbnRpdGllcyI6eyJlbWFpbCI6WyJ0ZXN0QGV4YW1wbGUuY29tIl19LCJzaWduX2luX3Byb3ZpZGVyIjoicGFzc3dvcmQifX0.bW9jay1zaWduYXR1cmUtZm9yLXRlc3Rpbmc';

let authToken = MOCK_AUTH_TOKEN;
let testUserId = process.env.TEST_USER_ID || 'test-user-123';

// CSRF token storage
let csrfToken = null;
let csrfCookie = null;

// Test results tracking
const results = {
  total: 0,
  passed: 0,
  failed: 0,
  tests: []
};

function log(message) {
  console.log(`[${new Date().toISOString()}] ${message}`);
}

function recordTest(name, passed, error = null) {
  results.total++;
  if (passed) {
    results.passed++;
  } else {
    results.failed++;
  }

  results.tests.push({
    name,
    passed,
    error: error ? error.message : null,
    timestamp: new Date().toISOString()
  });

  const status = passed ? 'âœ… PASS' : 'âŒ FAIL';
  log(`${status} ${name}`);
  if (error) {
    console.log(`   Error: ${error.message}`);
  }
}

// HTTP request helper
function makeRequest(url, options = {}) {
  return new Promise((resolve, reject) => {
    const protocol = url.startsWith('https:') ? https : http;
    const req = protocol.request(url, options, (res) => {
      let data = '';
      res.on('data', (chunk) => data += chunk);
      res.on('end', () => {
        try {
          const jsonData = data ? JSON.parse(data) : {};
          resolve({
            status: res.statusCode,
            headers: res.headers,
            data: jsonData
          });
        } catch (e) {
          resolve({
            status: res.statusCode,
            headers: res.headers,
            data: data
          });
        }
      });
    });

    req.on('error', reject);

    if (options.body) {
      req.write(JSON.stringify(options.body));
    }

    req.end();
  });
}

// Get CSRF token from server
async function getCsrfToken() {
  return new Promise((resolve, reject) => {
    const url = `${BASE_URL}/api/health`;
    const urlObj = new URL(url);

    const requestOptions = {
      hostname: urlObj.hostname,
      port: urlObj.port,
      path: urlObj.pathname + urlObj.search,
      method: 'GET',
      headers: {}
    };

    const protocol = url.startsWith('https://') ? https : http;
    const req = protocol.request(requestOptions, (res) => {
      let data = '';

      // Extract CSRF cookie from response
      const setCookieHeader = res.headers['set-cookie'];
      if (setCookieHeader) {
        const csrfCookieMatch = setCookieHeader.find(cookie => cookie.startsWith('__csrf-token='));
        if (csrfCookieMatch) {
          csrfCookie = csrfCookieMatch.split(';')[0].split('=')[1];
          csrfToken = csrfCookie;
        }
      }

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        resolve({ status: res.statusCode, csrfToken, csrfCookie });
      });
    });

    req.on('error', () => {
      resolve(false);
    });

    req.on('timeout', () => {
      req.destroy();
      resolve(false);
    });

    req.end();
  });
}

// API request helper with auth
async function apiRequest(method, path, body = null, auth = true) {
  const url = `${BASE_URL}${path}`;
  const headers = {
    'Content-Type': 'application/json',
    'User-Agent': 'HireAll-API-Test/1.0'
  };

  if (auth && authToken) {
    headers['Authorization'] = `Bearer ${authToken}`;
  }

  // Add CSRF token for non-GET requests
  if (method !== 'GET' && csrfToken) {
    headers['x-csrf-token'] = csrfToken;
    if (csrfCookie) {
      headers['Cookie'] = `__csrf-token=${csrfCookie}`;
    }
  }

  const options = {
    method,
    headers
  };

  if (body) {
    options.body = body;
  }

  return makeRequest(url, options);
}

// Authentication setup
async function setupAuth() {
  log('Setting up mock authentication...');

  try {
    // Get CSRF token first
    const csrfResult = await getCsrfToken();
    if (!csrfResult || !csrfResult.csrfToken) {
      throw new Error('Failed to obtain CSRF token');
    }
    log('CSRF token obtained');

    // Use mock authentication
    recordTest('Authentication Setup', true);
    log(`Using mock authentication for user: ${testUserId}`);
  } catch (error) {
    recordTest('Authentication Setup', false, error);
    throw error;
  }
}

// Test AI endpoints
async function testAiEndpoints() {
  log('Testing AI endpoints...');

  // Test cover letter generation
  try {
    const coverLetterData = {
      jobTitle: 'Software Engineer',
      companyName: 'Tech Corp',
      jobDescription: 'We are looking for a skilled software engineer...',
      resumeData: {
        personalInfo: { name: 'John Doe' },
        experience: [],
        skills: []
      }
    };

    const response = await apiRequest('POST', '/api/ai/cover-letter', coverLetterData);
    if (response.status === 200 || response.status === 201 || response.status === 400) {
      recordTest('POST /api/ai/cover-letter - Cover Letter Generation', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('POST /api/ai/cover-letter - Cover Letter Generation', false, error);
  }

  // Test resume optimization
  try {
    const resumeData = {
      resumeData: {
        personalInfo: { name: 'John Doe' },
        experience: [],
        skills: []
      },
      jobDescription: 'Software engineer position...'
    };

    const response = await apiRequest('POST', '/api/ai/resume', resumeData);
    if (response.status === 200 || response.status === 201 || response.status === 400) {
      recordTest('POST /api/ai/resume - Resume Optimization', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('POST /api/ai/resume - Resume Optimization', false, error);
  }
}

// Test chatbot endpoints
async function testChatbotEndpoints() {
  log('Testing chatbot endpoints...');

  try {
    const chatData = {
      message: 'Hello, can you help me with my job search?',
      context: 'job_search'
    };

    const response = await apiRequest('POST', '/api/chatbot', chatData);
    if (response.status === 200 || response.status === 201 || response.status === 400) {
      recordTest('POST /api/chatbot - Chatbot Interaction', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('POST /api/chatbot - Chatbot Interaction', false, error);
  }
}

// Test user endpoints
async function testUserEndpoints() {
  log('Testing user endpoints...');

  try {
    const response = await apiRequest('GET', '/api/user/autofill-profile');
    if (response.status === 200 || response.status === 201 || response.status === 400) {
      recordTest('GET /api/user/autofill-profile - Profile Autofill', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('GET /api/user/autofill-profile - Profile Autofill', false, error);
  }

  try {
    const response = await apiRequest('GET', '/api/user/uk-sponsorship-criteria');
    if (response.status === 200 || response.status === 201 || response.status === 400) {
      recordTest('GET /api/user/uk-sponsorship-criteria - UK Sponsorship Criteria', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('GET /api/user/uk-sponsorship-criteria - UK Sponsorship Criteria', false, error);
  }
}

// Test settings endpoints
async function testSettingsEndpoints() {
  log('Testing settings endpoints...');

  // Test preferences
  try {
    const preferencesData = {
      theme: 'dark',
      emailNotifications: true,
      pushNotifications: false
    };

    const response = await apiRequest('PUT', '/api/settings/preferences', preferencesData);
    if (response.status === 200 || response.status === 201 || response.status === 400) {
      recordTest('PUT /api/settings/preferences - User Preferences', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('PUT /api/settings/preferences - User Preferences', false, error);
  }

  // Test notifications
  try {
    const notificationsData = {
      emailNotifications: true,
      pushNotifications: false,
      jobAlertsEnabled: true
    };

    const response = await apiRequest('PUT', '/api/settings/notifications', notificationsData);
    if (response.status === 200 || response.status === 201 || response.status === 400) {
      recordTest('PUT /api/settings/notifications - Notification Settings', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('PUT /api/settings/notifications - Notification Settings', false, error);
  }

  // Test sessions
  try {
    const response = await apiRequest('GET', '/api/settings/sessions');
    if (response.status === 200 || response.status === 401) {
      recordTest('GET /api/settings/sessions - User Sessions', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('GET /api/settings/sessions - User Sessions', false, error);
  }
}

// Test subscription endpoints
async function testSubscriptionEndpoints() {
  log('Testing subscription endpoints...');

  // Test subscription status
  try {
    const response = await apiRequest('GET', '/api/subscription/status');
    if (response.status === 200 || response.status === 401) {
      recordTest('GET /api/subscription/status - Subscription Status', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('GET /api/subscription/status - Subscription Status', false, error);
  }

  // Test subscription portal
  try {
    const response = await apiRequest('POST', '/api/subscription/portal');
    if (response.status === 200 || response.status === 201 || response.status === 401) {
      recordTest('POST /api/subscription/portal - Billing Portal', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('POST /api/subscription/portal - Billing Portal', false, error);
  }
}

// Test health endpoint
async function testHealthEndpoint() {
  log('Testing health endpoint...');

  try {
    const response = await apiRequest('GET', '/api/health', null, false); // No auth required
    if (response.status === 200) {
      recordTest('GET /api/health - Health Check', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('GET /api/health - Health Check', false, error);
  }
}

// Test rate limit endpoints
async function testRateLimitEndpoints() {
  log('Testing rate limit endpoints...');

  try {
    const response = await apiRequest('GET', '/api/rate-limit-status');
    if (response.status === 200 || response.status === 401) {
      recordTest('GET /api/rate-limit-status - Rate Limit Status', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('GET /api/rate-limit-status - Rate Limit Status', false, error);
  }

  try {
    const response = await apiRequest('POST', '/api/rate-limit-check');
    if (response.status === 200 || response.status === 401) {
      recordTest('POST /api/rate-limit-check - Rate Limit Check', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('POST /api/rate-limit-check - Rate Limit Check', false, error);
  }
}

// Test contact endpoint
async function testContactEndpoint() {
  log('Testing contact endpoint...');

  try {
    const contactData = {
      name: 'John Doe',
      email: 'john@example.com',
      message: 'Hello, I have a question about your service.'
    };

    const response = await apiRequest('POST', '/api/contact', contactData, false); // May not require auth
    if (response.status === 200 || response.status === 201 || response.status === 400) {
      recordTest('POST /api/contact - Contact Form', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('POST /api/contact - Contact Form', false, error);
  }
}

// Test blog endpoints
async function testBlogEndpoints() {
  log('Testing blog endpoints...');

  try {
    const response = await apiRequest('GET', '/api/blog/posts', null, false); // Public endpoint
    if (response.status === 200) {
      recordTest('GET /api/blog - Blog Posts', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('GET /api/blog - Blog Posts', false, error);
  }
}

// Test interview questions endpoints
async function testInterviewQuestionsEndpoints() {
  log('Testing interview questions endpoints...');

  try {
    const response = await apiRequest('GET', '/api/interview-questions');
    if (response.status === 200 || response.status === 401) {
      recordTest('GET /api/interview-questions - Interview Questions', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('GET /api/interview-questions - Interview Questions', false, error);
  }
}

// Test SOC codes endpoint
async function testSocCodesEndpoint() {
  log('Testing SOC codes endpoint...');

  try {
    const response = await apiRequest('GET', '/api/soc-codes'); // Requires auth for mock token support
    if (response.status === 200) {
      recordTest('GET /api/soc-codes - SOC Codes', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('GET /api/soc-codes - SOC Codes', false, error);
  }
}

// Test sponsors endpoint
async function testSponsorsEndpoint() {
  log('Testing sponsors endpoint...');

  try {
    const response = await apiRequest('GET', '/api/sponsors', null, false); // Public endpoint
    if (response.status === 200) {
      recordTest('GET /api/sponsors - Sponsors', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('GET /api/sponsors - Sponsors', false, error);
  }
}

// Test subdomain endpoint
async function testSubdomainEndpoint() {
  log('Testing subdomain endpoint...');

  try {
    const subdomainData = {
      subdomain: 'johndoe'
    };

    const response = await apiRequest('POST', '/api/subdomain', subdomainData);
    if (response.status === 200 || response.status === 201 || response.status === 400 || response.status === 409) {
      recordTest('POST /api/subdomain - Subdomain Setup', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('POST /api/subdomain - Subdomain Setup', false, error);
  }
}

// Test CV endpoint
async function testCvEndpoint() {
  log('Testing CV endpoint...');

  try {
    const response = await apiRequest('GET', '/api/cv/user');
    if (response.status === 200 || response.status === 401) {
      recordTest('GET /api/cv - CV Access', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('GET /api/cv - CV Access', false, error);
  }
}

// Test email endpoints
async function testEmailEndpoints() {
  log('Testing email endpoints...');

  try {
    const emailData = {
      email: 'test@example.com',
      name: 'Test User'
    };

    const response = await apiRequest('POST', '/api/email/welcome', emailData);
    if (response.status === 200 || response.status === 201 || response.status === 400 || response.status === 401) {
      recordTest('POST /api/email - Email Sending', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('POST /api/email - Email Sending', false, error);
  }
}

// Test Stripe endpoints
async function testStripeEndpoints() {
  log('Testing Stripe endpoints...');

  try {
    const response = await apiRequest('POST', '/api/stripe/webhook', {}, false); // Webhooks may not need auth
    if (response.status === 200 || response.status === 400) {
      recordTest('POST /api/stripe/webhook - Stripe Webhook', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('POST /api/stripe/webhook - Stripe Webhook', false, error);
  }
}

// Test auth endpoints
async function testAuthEndpoints() {
  log('Testing auth endpoints...');

  // Test password reset request
  try {
    const passwordData = {
      email: 'test@example.com'
    };

    const response = await apiRequest('POST', '/api/auth/password/request', passwordData, false);
    if (response.status === 200 || response.status === 201 || response.status === 400) {
      recordTest('POST /api/auth/password - Password Reset', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('POST /api/auth/password - Password Reset', false, error);
  }

  // Test session validation
  try {
    const response = await apiRequest('GET', '/api/auth/session');
    if (response.status === 200 || response.status === 401) {
      recordTest('GET /api/auth/session - Session Validation', true);
    } else {
      throw new Error(`Unexpected status: ${response.status}`);
    }
  } catch (error) {
    recordTest('GET /api/auth/session - Session Validation', false, error);
  }
}

// Main test runner
async function runTests() {
  log('ðŸš€ Starting Comprehensive HireAll API Tests');
  log(`Testing against: ${BASE_URL}`);

  try {
    await setupAuth();

    // Test all endpoint categories
    await testHealthEndpoint();
    await testAiEndpoints();
    await testChatbotEndpoints();
    await testUserEndpoints();
    await testSettingsEndpoints();
    await testSubscriptionEndpoints();
    await testRateLimitEndpoints();
    await testContactEndpoint();
    await testBlogEndpoints();
    await testInterviewQuestionsEndpoints();
    await testSocCodesEndpoint();
    await testSponsorsEndpoint();
    await testSubdomainEndpoint();
    await testCvEndpoint();
    await testEmailEndpoints();
    await testStripeEndpoints();
    await testAuthEndpoints();

    // Print results
    log('\nðŸ“Š Comprehensive API Test Results Summary:');
    log(`Total Tests: ${results.total}`);
    log(`Passed: ${results.passed}`);
    log(`Failed: ${results.failed}`);
    log(`Success Rate: ${((results.passed / results.total) * 100).toFixed(1)}%`);

    if (results.failed > 0) {
      log('\nâŒ Failed Tests:');
      results.tests.filter(t => !t.passed).forEach(test => {
        log(`  - ${test.name}: ${test.error}`);
      });
    }

    log('\nâœ… Comprehensive API testing completed!');

    // Exit with appropriate code
    process.exit(results.failed > 0 ? 1 : 0);

  } catch (error) {
    log(`ðŸ’¥ Test suite failed: ${error.message}`);
    process.exit(1);
  }
}

// Run the tests
if (require.main === module) {
  runTests();
}

module.exports = { runTests };